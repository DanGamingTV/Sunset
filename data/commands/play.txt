const RichEmbed = require("discord.js").RichEmbed;
const Discord = require("discord.js");
const moment = require("moment")
var embedfooter = moment().format('h:mm:ss a') + 'EST on ' +  moment().format('MMMM Do YYYY')
const momentdate = moment().format('MMMM Do YYYY')
const momentday = moment().format('dddd')
const request = require("request")
const cheerio = require('cheerio')
const snekfetch = require('snekfetch')
const querystring = require('querystring')
const ytdl = require("ytdl-core")
module.exports.run = (client, message, args) => {
  const modlog = message.guild.channels.find('name', 'mod-log');
  const announcements = message.guild.channels.find('name', 'announcements')
const voiceChannel = message.member.voiceChannel;
if (message.author.id !== data.ownerid) return message.channel.send('**There is currently an issue with FFMPEG Libraries not being compatible with Linux Operating Systems.** \n This command will be disabled until a fix is made.')
if (!voiceChannel) return message.reply("**You must be in a voice channel.**").catch(console.error);
voiceChannel.leave()

const simplegooglesearch = message.content.split(' ').slice(1).join(' ')
const ytgooglesearch = 'www.youtube.com/watch?=' + message.content.split(' ').slice(1).join(' ')
const ytsearchUrl = `https://www.google.com/search?q=${encodeURIComponent(ytgooglesearch)}`;

return snekfetch.get(ytsearchUrl).then((result) => {
  const $ = cheerio.load(result.text);
  const ytgoogleData = $('.r').first().find('a').first().attr('href');
  ytgoogleData = querystring.parse(ytgoogleData.replace('/url?', ''));

const musictoplay = message.content.split(' ').slice(1).join('')
const youtubeurl = `www.youtube.com`
const volume2set = message.content.split(/\s+/g).slice(2).join(" ");
var musiclengtherror = new Discord.RichEmbed()
  .setColor(data.embedcolor)
  .setTitle('Music Commands Usage (Play)')
  .setDescription('You must provide a search term for YouTube')
  .addField(data.prefix + 'play <youtube_video>','<youtube_video> = Search Term for Youtube Video')
  // removed 

if(musictoplay.length < 1) return message.channel.send({embed: musiclengtherror}).catch(console.error);



voiceChannel.join()
.then(connnection => {
  const stream = ytdl(`${ytgoogleData.q}`, { filter: 'audioonly' });
  message.channel.send(':play_pause: **Now Playing** ' + `${ytgoogleData.q}`)

  const dispatcher = connnection.playStream(stream);
  dispatcher.on('end', () => voiceChannel.leave());
  dispatcher.on('error', error => {
    console.log(error)
  });
  console.log('YTDL | ' + `${ytgoogleData.q}` + ' | ' + message.guild.name + ' | ' + message.author.username)
  var playmlembed = new Discord.RichEmbed()
    .setColor('FFCE00')
    .setTitle('Play Command Used')
    .setDescription(message.author.username)
    .addField(`${ytgoogleData.q}`,'_')
    .setAuthor(message.author.username ,message.author.avatarURL)
    // removed 
  if(modlog) return modlog.send({embed: playmlembed}).catch(console.error);
});
});
}
module.exports.help = {
  name: "play",
  info: "Play a song",
  usage: "play <title>"
}
